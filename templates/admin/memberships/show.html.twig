{% extends 'admin/base.html.twig' %}

{% block page_title %}Dettaglio Iscrizione #{{ membership.id }}{% endblock %}
{% block page_subtitle %}Informazioni complete sull'iscrizione{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ path('admin_memberships') }}" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Torna alla lista
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {# Main Info #}
    <div class="lg:col-span-2 space-y-6">
        {# Membership Info Card #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Informazioni Iscrizione</h3>
                <span class="px-3 py-1 text-sm font-medium rounded-full
                    {% if membership.status == 'active' %}bg-green-100 text-green-800
                    {% elseif membership.status == 'expired' %}bg-orange-100 text-orange-800
                    {% elseif membership.status == 'cancelled' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ membership.status|upper }}
                </span>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Data Inizio</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.startDate|date('d/m/Y') }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Data Fine</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.endDate|date('d/m/Y') }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Data Creazione</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.createdAt|date('d/m/Y H:i') }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Ultimo Aggiornamento</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.updatedAt|date('d/m/Y H:i') }}</p>
                </div>
            </div>

            {% if membership.notes %}
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">Note</p>
                    <p class="text-base text-gray-900">{{ membership.notes }}</p>
                </div>
            {% endif %}
        </div>

        {# User Info Card #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Informazioni Utente</h3>

            <div class="flex items-center mb-6">
                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center">
                    <span class="text-primary-600 font-bold text-xl">
                        {{ membership.user.firstName|slice(0, 1) ~ membership.user.lastName|slice(0, 1) }}
                    </span>
                </div>
                <div class="ml-4">
                    <p class="text-xl font-semibold text-gray-900">
                        {{ membership.user.firstName }} {{ membership.user.lastName }}
                    </p>
                    <p class="text-sm text-gray-600">{{ membership.user.email }}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Data di Nascita</p>
                    <p class="text-base font-medium text-gray-900">
                        {{ membership.user.dateOfBirth ? membership.user.dateOfBirth|date('d/m/Y') : 'N/D' }}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Telefono</p>
                    <p class="text-base font-medium text-gray-900">
                        {{ membership.user.phoneNumber ?? 'N/D' }}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Genere</p>
                    <p class="text-base font-medium text-gray-900">
                        {% if membership.user.gender == 'male' %}Maschio
                        {% elseif membership.user.gender == 'female' %}Femmina
                        {% else %}Altro{% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Ruoli</p>
                    <div class="flex flex-wrap gap-1">
                        {% for role in membership.user.roles %}
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                                {{ role }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# Gym Info Card #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Informazioni Palestra</h3>

            <div class="mb-6">
                <p class="text-xl font-semibold text-gray-900">{{ membership.gym.name }}</p>
                <p class="text-sm text-gray-600 mt-1">{{ membership.gym.description }}</p>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Indirizzo</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.gym.address }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Citt√†</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.gym.city }} ({{ membership.gym.postalCode }})</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Email</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.gym.email }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-1">Telefono</p>
                    <p class="text-base font-medium text-gray-900">{{ membership.gym.phoneNumber }}</p>
                </div>
            </div>
        </div>

        {# Medical Certificate Card #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Certificato Medico</h3>
                {% if certificate %}
                    <span class="px-3 py-1 text-sm font-medium rounded-full
                        {% if certificate.status == 'approved' %}bg-green-100 text-green-800
                        {% elseif certificate.status == 'pending_review' %}bg-yellow-100 text-yellow-800
                        {% elseif certificate.status == 'rejected' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {% if certificate.status == 'approved' %}APPROVATO
                        {% elseif certificate.status == 'pending_review' %}IN REVISIONE
                        {% elseif certificate.status == 'rejected' %}RIFIUTATO
                        {% else %}{{ certificate.status|upper }}{% endif %}
                    </span>
                {% endif %}
            </div>

            {% if certificate %}
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Tipo Certificato</p>
                        <p class="text-base font-medium text-gray-900">
                            {% if certificate.certificateType == 'agonistic' %}Agonistico
                            {% elseif certificate.certificateType == 'non_agonistic' %}Non Agonistico
                            {% else %}{{ certificate.certificateType }}{% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Data Scadenza</p>
                        <p class="text-base font-medium text-gray-900">
                            {{ certificate.expiryDate|date('d/m/Y') }}
                            {% set today = 'now'|date('Y-m-d') %}
                            {% if certificate.expiryDate|date('Y-m-d') < today %}
                                <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded">SCADUTO</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Data Caricamento</p>
                        <p class="text-base font-medium text-gray-900">{{ certificate.uploadedAt|date('d/m/Y H:i') }}</p>
                    </div>
                    {% if certificate.reviewedAt %}
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Data Revisione</p>
                            <p class="text-base font-medium text-gray-900">{{ certificate.reviewedAt|date('d/m/Y H:i') }}</p>
                        </div>
                    {% endif %}
                </div>

                {% if certificate.notes %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-2">Note</p>
                        <p class="text-base text-gray-900">{{ certificate.notes }}</p>
                    </div>
                {% endif %}

                <div class="mt-6 pt-6 border-t border-gray-200 flex gap-3">
                    {% if certificate.filePath %}
                        <a
                            href="{{ path('admin_certificate_show', {'id': certificate.id}) }}"
                            target="_blank"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Visualizza PDF
                        </a>
                    {% endif %}

                    {% if certificate.status == 'pending_review' %}
                        <form method="post" action="{{ path('admin_certificate_approve', {'id': certificate.id}) }}" class="inline">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Approva
                            </button>
                        </form>
                        <form method="post" action="{{ path('admin_certificate_reject', {'id': certificate.id}) }}" class="inline" onsubmit="return confirm('Sei sicuro di voler rifiutare questo certificato?')">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Rifiuta
                            </button>
                        </form>
                    {% endif %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-gray-500 font-medium">Nessun certificato medico caricato</p>
                    <p class="text-sm text-gray-400 mt-1">L'utente non ha ancora caricato un certificato medico</p>
                    <div class="mt-6">
                        <a
                            href="{{ path('admin_certificate_upload', {'userId': membership.user.id}) }}"
                            class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Carica Certificato
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    {# Sidebar Actions #}
    <div class="lg:col-span-1 space-y-6">
        {# Quick Stats #}
        <div class="bg-gradient-to-br from-primary-600 to-primary-700 rounded-lg shadow-md p-6 text-white">
            <h3 class="text-lg font-semibold mb-4">Riepilogo Rapido</h3>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm">Giorni Totali</span>
                    <span class="text-xl font-bold">
                        {{ membership.startDate.diff(membership.endDate).days }}
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Giorni Rimanenti</span>
                    <span class="text-xl font-bold">
                        {% set today = 'now'|date('Y-m-d') %}
                        {% set remaining = membership.endDate.diff(date(today)).days %}
                        {{ remaining > 0 ? remaining : 0 }}
                    </span>
                </div>
            </div>
        </div>

        {# Actions Card #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Azioni</h3>

            <div class="space-y-3">
                <a href="{{ path('admin_membership_edit', {'id': membership.id}) }}" class="block w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium text-center">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Modifica Dati
                </a>

                {% if membership.status == 'active' %}
                    <form method="post" action="{{ path('admin_membership_cancel', {'id': membership.id}) }}" onsubmit="return confirm('Sei sicuro di voler cancellare questa iscrizione?');">
                        <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Cancella Iscrizione
                        </button>
                    </form>
                {% elseif membership.status == 'cancelled' or membership.status == 'expired' %}
                    <form method="post" action="{{ path('admin_membership_reactivate', {'id': membership.id}) }}" onsubmit="return confirm('Sei sicuro di voler riattivare questa iscrizione?');">
                        <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Riattiva Iscrizione
                        </button>
                    </form>
                {% endif %}

                <a href="mailto:{{ membership.user.email }}" class="block w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium text-center">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Invia Email
                </a>
            </div>
        </div>

        {# Info Card #}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm text-blue-800">
                    <p class="font-medium mb-1">Nota</p>
                    <p>Le modifiche alle iscrizioni vengono registrate nel sistema e possono essere auditate.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
