{% extends 'admin/base.html.twig' %}

{% block page_title %}Scansiona Check-in{% endblock %}
{% block page_subtitle %}Registra ingresso/uscita utenti{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ path('admin_check_in') }}" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Torna alla lista
    </a>
</div>

<div class="max-w-2xl mx-auto">
    {# Form Ricerca Utente #}
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Cerca Utente</h3>

        <form id="checkInForm" class="space-y-4">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                    Email o Codice Utente
                </label>
                <input
                    type="text"
                    id="search"
                    name="search"
                    autocomplete="off"
                    placeholder="mario.rossi@example.com o #12345"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg"
                    autofocus
                >
            </div>

            <button
                type="submit"
                class="w-full px-6 py-4 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium text-lg"
            >
                <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Verifica e Registra
            </button>
        </form>
    </div>

    {# Messaggio Risultato #}
    <div id="resultMessage" class="hidden"></div>
</div>

<script>
const form = document.getElementById('checkInForm');
const searchInput = document.getElementById('search');
const resultDiv = document.getElementById('resultMessage');

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const searchValue = searchInput.value.trim();
    if (!searchValue) {
        showMessage('error', 'Inserisci un email o codice utente');
        return;
    }

    // Determina se è email o ID
    const isEmail = searchValue.includes('@');
    const data = new FormData();

    if (isEmail) {
        data.append('email', searchValue);
    } else {
        // Rimuovi # se presente
        const userId = searchValue.replace('#', '');
        data.append('user_id', userId);
    }

    try {
        const response = await fetch('{{ path('admin_check_in_process') }}', {
            method: 'POST',
            body: data
        });

        const result = await response.json();

        if (result.success) {
            if (result.action === 'check_in') {
                showMessage('success', `✓ Check-in effettuato!\n${result.user.name}\nOra: ${result.user.checkInTime}`, result.user);
            } else {
                showMessage('success', `✓ Check-out effettuato!\n${result.user.name}\nDurata: ${result.user.duration}`, result.user);
            }
            searchInput.value = '';

            // Ricarica dopo 3 secondi
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 3000);
        } else {
            showMessage('error', result.message, result.user);
        }
    } catch (error) {
        showMessage('error', 'Errore di connessione. Riprova.');
    }
});

function showMessage(type, message, user = null) {
    const isSuccess = type === 'success';
    const bgColor = isSuccess ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
    const textColor = isSuccess ? 'text-green-800' : 'text-red-800';
    const iconColor = isSuccess ? 'text-green-600' : 'text-red-600';

    const icon = isSuccess
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';

    resultDiv.className = `p-6 ${bgColor} border-2 rounded-lg`;
    resultDiv.innerHTML = `
        <div class="flex items-start">
            <svg class="w-8 h-8 ${iconColor} mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${icon}
            </svg>
            <div class="flex-1">
                <p class="${textColor} font-medium text-xl whitespace-pre-line">${message}</p>
                ${user ? `<p class="text-sm ${textColor} mt-2">${user.email}</p>` : ''}
            </div>
        </div>
    `;
    resultDiv.classList.remove('hidden');

    // Suono feedback (opzionale)
    if (isSuccess) {
        playBeep('success');
    } else {
        playBeep('error');
    }
}

function playBeep(type) {
    // Crea un beep audio usando Web Audio API
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.frequency.value = type === 'success' ? 800 : 400;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + 0.2);
}

// Auto-focus su input dopo submit
form.addEventListener('submit', () => {
    setTimeout(() => searchInput.focus(), 100);
});
</script>
{% endblock %}
